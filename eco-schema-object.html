<link rel="import" href="../polymer/polymer.html"/>
<link rel="import" href="../iron-flex-layout/iron-flex-layout.html"/>

<dom-module id="eco-schema-object">

  <link rel="import" href="../paper-input/paper-input.html"/>

  <link rel="import" href="./eco-schema-array.html"/>

  <template>

    <style>

      :host {
        display: block;
      }

    </style>

    <div class="vertical layout">

      <div class="flex header" hidden$="[[!label]]">[[label]]</div>
      <div id="form"></div>

    </div>

  </template>

  <script>
    Polymer({
      is: 'eco-schema-object',
      properties: {
        schema: {
          type: Object,
          observer: '_schemaChanged'
        },
        label: {
          type: String
        },
        value: {
          type: Object,
          notify: true,
          value: function() { return {}; }
        }
      },
      ready: function() {

      },
      detached: function () {
        this._clearForm();
      },
      _buildSchemaProperties: function(schema) {

        if (!schema.properties) {
          return [];
        }

        return Object.keys(schema.properties).map(function(key) {
          var property = schema.properties[key];
          var edit = {
            property: key,
            label: property.title || key,
            type: property.type,
            schema: property,
            component: property.component,
            valueProperty: property.valueProperty || 'value'
          };

          if (property.type === 'object') {
            edit.value = {};
          } else if (property.type === 'array') {
            edit.value = [];
          } else {
            edit.value = '';
          }
          return edit;
        });
      },
      _schemaPropertyChanged: function (event, detail) {

        if (detail.path && /\.length$/.test(detail.path)) {
          return;
        }

        var ctx = this;
        var property = event.target.schemaProperty;
        var path = ['value', property.property];

        if (detail.path && /\.splices$/.test(detail.path)) {
          var parts = detail.path.split('.').slice(1, -1);
          while (parts.length) {
            path.push(parts.shift());
            if (property.keyMap && property.keyMap[path.join('.')]) {
              path = property.keyMap[path.join('.')].split('.');
            }
          }

          if (detail.value.keySplices) {
            if (property.keyMap) {
              detail.value.keySplices.forEach(function(splice) {
                splice.removed.forEach(function (k) {
                  delete property.keyMap[path.concat([k]).join('.')];
                });
              });
            }
          }

          detail.value.indexSplices.forEach(function(splice) {
            var args = [path.join('.'), splice.index, splice.removed.length];
            if (splice.addedCount) {
              for (var i = 0, ii = splice.addedCount; i < ii; i++) {
                if (splice.addedKeys && splice.addedKeys[i]) {
                  property.keyMap = property.keyMap || {};
                  property.keyMap[path.concat([splice.addedKeys[i]]).join('.')] = path.concat([i + splice.index]).join('.');
                }
                args.push(ctx._deepClone(splice.object[i + splice.index]));
              }
            }
            ctx.splice.apply(ctx, args);
          });
        } else if (detail.path) {
          var parts = detail.path.split('.').slice(1);
          while (parts.length) {
            path.push(parts.shift());
            if (property.keyMap && property.keyMap[path.join('.')]) {
              path = property.keyMap[path.join('.')].split('.');
            }
          }
          this.set(path, this._deepClone(detail.value));
        } else {
          property.value = detail.value;
          this.set(path, this._deepClone(detail.value));
        }
      },
      _setValue: function() {
        var ctx = this;
        var value = {};
        this._schemaProperties.forEach(function (property) {
          value[property.property] = ctx._deepClone(property.value);
        });
        this.value = value;
      },
      _buildForm: function() {
        var ctx = this;
        this._schemaProperties.forEach(function(property) {
          var valueProperty = property.valueProperty;
          var component = null;

          if (property.component) {
            component = property.component;
          } else if (ctx._isSchemaValue(property.type)) {
            component = 'paper-input';
          } else if (ctx._isSchemaObject(property.type)) {
            component = 'eco-schema-object';
          } else if (ctx._isSchemaArray(property.type)) {
            component = 'eco-schema-array';
          } else {
            return console.error('Unknown property type %s', property.type);
          }

          var el = ctx.create(component, {
            label: property.label,
            schema: property.schema,
            schemaProperty: property
          });

          property.value = el[valueProperty];
          ctx.listen(el, valueProperty.replace(/([A-Z])/g, '-$1').toLowerCase() + '-changed', '_schemaPropertyChanged');
          Polymer.dom(ctx.$.form).appendChild(el);
        });
      },
      _removePropertyEl: function (el) {
        this.unlisten(el, el.schemaProperty.valueProperty.replace(/([A-Z])/g, '-$1').toLowerCase() + '-changed', '_schemaPropertyChanged');
        el.schemaProperty = null;
        Polymer.dom(this.$.form).removeChild(el);
      },
      _clearForm: function () {
        var formEl = Polymer.dom(this.$.form);
        while (formEl.firstChild) {
          this._removePropertyEl(formEl.firstChild);
        }
      },
      _schemaChanged: function() {
        this._clearForm();
        this._schemaProperties = this._buildSchemaProperties(this.schema);
        this._buildForm();
        this._setValue();
      },
      _deepClone: function(o) {
        return JSON.parse(JSON.stringify(o));
      },
      _isSchemaValue: function(type) {
        if (Array.isArray(type)) {
          return type.indexOf('string') !== -1 || type.indexOf('number') !== -1 || type.indexOf('boolean') !== -1;
        } else {
          return type === 'string' || type === 'number' || type === 'boolean';
        }
      },
      _isSchemaObject: function(type) {
        return type === 'object';
      },
      _isSchemaArray: function(type) {
        return type === 'array';
      }
    });
  </script>

</dom-module>
