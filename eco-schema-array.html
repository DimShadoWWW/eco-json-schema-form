<link rel="import" href="../polymer/polymer.html"/>
<link rel="import" href="../iron-flex-layout/iron-flex-layout.html"/>

<dom-module id="eco-schema-array">

  <link rel="import" href="../iron-icons/iron-icons.html"/>
  <link rel="import" href="../paper-icon-button/paper-icon-button.html"/>
  <link rel="import" href="../paper-input/paper-input.html"/>

  <link rel="import" href="./eco-schema-object.html"/>

  <template>

    <style>

      :host {
        display: block;
      }

    </style>

    <div class="vertical layout">

      <div class="horizontal center layout">
        <div class="flex header" hidden$="[[!label]]">[[label]]</div>
        <paper-icon-button icon="add" on-click="_onAddItem"></paper-icon-button>
      </div>

      <div id="form"></div>

    </div>

  </template>

  <script>
    Polymer({
      is: 'eco-schema-array',
      properties: {
        schema: {
          type: Object,
          observer: '_schemaChanged'
        },
        label: {
          type: String
        },
        value: {
          type: Object,
          notify: true,
          value: function() { return []; }
        }
      },
      _buildSchemaArrayItems: function(schema) {
        if (this.value && this.value.length) {
          return this.value.map(function(item) {
            return {
              label: schema.items.title,
              type: schema.items.type,
              schema: schema.items,
              value: item
            };
          });
        } else {
          return [];
        }
      },
      _schemaArrayItemChanged: function(event, detail) {
        console.log(event, detail);

        var arrayEls = Array.prototype.slice.apply(this.$.form.children);
        var itemIndex = arrayEls.indexOf(event.target);
        var valuePath = ['value', itemIndex];

        console.log(valuePath, detail);

        if (detail.path) {
          valuePath = valuePath.concat(detail.path.split('.').slice(1));
        }
        this.set(valuePath, detail.value);
      },
//      _buildSchemaEl: function(schema) {
//        var el = null;
//        if (this._isSchemaValue(schema.type)) {
//          el = this.create('paper-input', {
//            label: schema.label,
//            name: schema.property,
//            value: ''
//          });
//          this.listen(el, 'value-changed', '_schemaArrayItemChanged');
//          el.schemaProperty = schema;
//        } else if (this._isSchemaObject(schema.type)) {
//          el = this.create('eco-schema-object', {
//            label: schema.label,
//            value: {}
//          });
//          el.schemaProperty = schema;
//          this.listen(el, 'value-changed', '_schemaArrayItemChanged');
//          el.schema = schema;
//        } else if (this._isSchemaArray(schema.type)) {
//          el = this.create('eco-schema-array', {
//            label: schema.label,
//            value: []
//          });
//          el.schemaProperty = schema;
//          this.listen(el, 'value-changed', '_schemaArrayItemChanged');
//          el.schema = schema;
//        }
//
//        return el;
//      },
      _buildForm: function() {
        var ctx = this;
        this._schemaArrayItems.forEach(function (item) {
          var el = ctx._buildSchemaEl(item.items);
          Polymer.dom(ctx.$.form).appendChild(el);
        });
      },
      _schemaChanged: function() {
        this._schemaArrayItems = this._buildSchemaArrayItems(this.schema);
      },
      _onAddItem: function() {
        var schema = this.schema.items;
        var el = null;

        if (this._isSchemaValue(schema.type)) {
          el = this.create('paper-input', {
            label: schema.label
          });
          this.listen(el, 'value-changed', '_schemaArrayItemChanged');
          Polymer.dom(this.$.form).appendChild(el);

//          var arrayEls = Array.prototype.slice.apply(this.$.form.children);
//          var itemIndex = arrayEls.indexOf(el);
//          el.value = 'w';
//          console.log(itemIndex);
//          console.log(el.value);

//          this.set(['value', itemIndex], el.value);
//          console.log(this.value);
        } else if (this._isSchemaObject(schema.type)) {
          el = this.create('eco-schema-object', {
            label: schema.label
          });
          Polymer.dom(this.$.form).appendChild(el);
          this.listen(el, 'value-changed', '_schemaArrayItemChanged');
          el.schema = schema;
        } else if (this._isSchemaArray(schema.type)) {
          el = this.create('eco-schema-array', {
            label: schema.label
          });
          Polymer.dom(this.$.form).appendChild(el);
          this.listen(el, 'value-changed', '_schemaArrayItemChanged');
          el.schema = schema;
        }




      },
      _onRemoveItem: function(e) {
        this._schemaArrayItems = this._schemaArrayItems.filter(function(item) {
          return item !== e.model.item
        });
      },
      _isSchemaValue: function(type) {
        if (Array.isArray(type)) {
          return type.indexOf('string') !== -1 || type.indexOf('number') !== -1 || type.indexOf('boolean') !== -1;
        } else {
          return type === 'string' || type === 'number' || type === 'boolean';
        }
      },
      _isSchemaObject: function(type) {
        return type === 'object';
      },
      _isSchemaArray: function(type) {
        return type === 'array';
      }
    });
  </script>

</dom-module>
