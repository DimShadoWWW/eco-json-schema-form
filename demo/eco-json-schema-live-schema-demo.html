<link rel="import" href="../../polymer/polymer.html"/>
<link rel="import" href="../../iron-flex-layout/iron-flex-layout.html"/>

<script src="../../ace-builds/src/ace.js"></script>
<link href="../../jsoneditor/dist/jsoneditor.min.css" rel="stylesheet" type="text/css">
<script src="../../jsoneditor/dist/jsoneditor.min.js"></script>

<dom-module id="eco-json-schema-live-schema-demo">

  <link rel="import" href="../../paper-material/paper-material.html"/>

  <link rel="import" href="../eco-schema-object.html" />
  <link rel="import" href="../eco-schema-array.html" />

  <style>

    paper-material {
      background: #ffffff;
      height: 100%;
    }

    paper-material, paper-material > * {
      margin: 10px;
    }

    .main-container {
      height: 800px;
    }

    #jsoneditor {
      width: 600px;
      height: 93%;
    }

  </style>
  <template>
    <div class="horizontal layout main-container">
      <paper-material>
        <h3>Schema Editor</h3>
        <div id="jsoneditor"></div>
      </paper-material>

      <paper-material class="flex-2">
        <h3>Generated Form</h3>
        <eco-schema-object id="schemaObj" schema="[[schema]]" value="{{value}}"></eco-schema-object>
      </paper-material>

      <paper-material class="flex">
        <h3>Value</h3>
        <pre id="valueText"></pre>
      </paper-material>
    </div>

  </template>
  <script>
    Polymer({
      is: 'eco-json-schema-live-schema-demo',
      observers: [
        '_valueChanged(value.*)'
      ],
      ready: function () {
        this._schema = {
          title: 'User',
          properties: {
            name: {
              type: 'string',
              title: 'Name'
            },
            emails: {
              type: 'array',
              title: 'Email Addresses',
              items: {
                type: 'object',
                title: 'Email Address',
                properties: {
                  type: {
                    type: 'string',
                    title: 'Type'
                  },
                  email: {
                    type: 'string',
                    title: 'Email'
                  }
                }
              }
            }
          }
        };

        var editorOpts = {
          mode: 'code',
          change: this._schemaChanged.bind(this)
        };

        this.editor = new JSONEditor(this.$.jsoneditor, editorOpts, this._schema);
      },
      _schemaChanged: function() {
        if (!this.editor) {
          console.log('Editor is falsey');
        } else {
          try {
            var json = JSON.parse(this.editor.getText());
            this.schema = json;
          } catch (e) {
            // bad, bad json
          }
        }
      },
      _valueChanged: function() {
        var json = JSON.stringify(this.value, null, ' ');
        this.$.valueText.innerHTML = json;
      }
    });
  </script>
</dom-module>
